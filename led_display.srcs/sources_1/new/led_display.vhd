library IEEE;
use IEEE.STD_LOGIC_1164.ALL;
use ieee.numeric_std.all;

-- Uncomment the following library declaration if using
-- arithmetic functions with Signed or Unsigned values
--use IEEE.NUMERIC_STD.ALL;

-- Uncomment the following library declaration if instantiating
-- any Xilinx leaf cells in this code.
--library UNISIM;
--use UNISIM.VComponents.all;

entity led_display is
    Port ( clk_i : in STD_LOGIC; --internal clock
           r_i : out STD_LOGIC_VECTOR (0 to 1); --red leds, top and bottom
           g_i : out STD_LOGIC_VECTOR (0 to 1); --green leds, top and bottom
           b_i : out STD_LOGIC_VECTOR (0 to 1); -- blue leds, top and bottom

           oe_i : out STD_LOGIC := '0'; -- output enable
           lat_i : out STD_LOGIC := '0'; -- latch
           clk_pin_i : out STD_LOGIC; -- clock pin of the display
           lines_i : out STD_LOGIC_VECTOR (0 to 3) := "0000"; --line selector
           led_i : out unsigned(15 downto 0);
           sw_i : in unsigned(15 downto 0);
           
           
           
           oe_debug_i : out STD_LOGIC;
           lat_debug_i: out STD_LOGIC;
           r0_debug_i: out STD_LOGIC;
           
           lines_debug_i : out STD_LOGIC_VECTOR (3 downto 0);
           clk_debug_i : out STD_LOGIC
           ); 
           
end led_display;

architecture Behavioral of led_display is

type STATE is (ENABLE_ON, SERIAL_OUT, SWITCH_LINE);
type letter_array is array(0 to 25) of std_logic_vector(0 to 319);

signal current_state: STATE := SERIAL_OUT;

signal display_clock: std_logic := '0';
signal internal_display_clock: std_logic := '0';
signal snail_clock: std_logic := '0';

--signal line_counter: integer range 0 to 15 := 0;
--signal led_counter: integer range 0 to 64 := 0;

constant display_div: integer := 3;

constant LED_START: integer := 0;

signal framebuffer: std_logic_vector(0 to 2047) := (others => '0');

constant letters: letter_array := (
--A
"00001111111100000000111111110000000011111111000000001111111100001111000000001111111100000000111111110000000011111111000000001111111111111111111111111111111111111111111111111111111111111111111111110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111000000001111",
--B
"11111111111100001111111111110000111111111111000011111111111100001111000000001111111100000000111111110000000011111111000000001111111111111111000011111111111100001111111111110000111111111111000011110000000011111111000000001111111100000000111111110000000011111111111111110000111111111111000011111111111100001111111111110000",
--C
"00001111111100000000111111110000000011111111000000001111111100001111000000001111111100000000111111110000000011111111000000001111111100000000000011110000000000001111000000000000111100000000000011110000000011111111000000001111111100000000111111110000000011110000111111110000000011111111000000001111111100000000111111110000",
--D
"11111111111100001111111111110000111111111111000011111111111100001111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111111111110000111111111111000011111111111100001111111111110000",
--E
"11111111111111111111111111111111111111111111111111111111111111111111000000000000111100000000000011110000000000001111000000000000111111111111000011111111111100001111111111110000111111111111000011110000000000001111000000000000111100000000000011110000000000001111111111111111111111111111111111111111111111111111111111111111",
--F
"11111111111111111111111111111111111111111111111111111111111111111111000000000000111100000000000011110000000000001111000000000000111111111111000011111111111100001111111111110000111111111111000011110000000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111000000000000",
--G
"00001111111100000000111111110000000011111111000000001111111100001111000000000000111100000000000011110000000000001111000000000000111100001111111111110000111111111111000011111111111100001111111111110000000011111111000000001111111100000000111111110000000011110000111111110000000011111111000000001111111100000000111111110000",
--H
"11110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111000000001111111111111111111111111111111111111111111111111111111111111111111111110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111000000001111",
--I
"00111111111111000011111111111100001111111111110000111111111111000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000011111111111100001111111111110000111111111111000011111111111100",
--J
"00000000000011110000000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111000000000000111111110000000011111111000000001111111100000000111111110000000011110000111111110000000011111111000000001111111100000000111111110000",
--K
"11110000000011111111000000001111111100000000111111110000000011111111000011110000111100001111000011110000111100001111000011110000111111110000000011111111000000001111111100000000111111110000000011110000111100001111000011110000111100001111000011110000111100001111000000001111111100000000111111110000000011111111000000001111",
--L
"11110000000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111111111111111111111111111111111111111111111111111111111111111",
--M
"11100000000001111110000000000111111000000000011111100000000001111111110000111111111111000011111111111100001111111111110000111111111000111100011111100011110001111110001111000111111000111100011111100000000001111110000000000111111000000000011111100000000001111110000000000111111000000000011111100000000001111110000000000111",
--N
"11110000000011111111000000001111111100000000111111110000000011111111111100001111111111110000111111111111000011111111111100001111111100001111111111110000111111111111000011111111111100001111111111110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111000000001111",
--O
"00001111111100000000111111110000000011111111000000001111111100001111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011110000111111110000000011111111000000001111111100000000111111110000",
--P
"11111111111100001111111111110000111111111111000011111111111100001111000000001111111100000000111111110000000011111111000000001111111111111111000011111111111100001111111111110000111111111111000011110000000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111000000000000",
--Q
"00001111111100000000111111110000000011111111000000001111111100001111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000111100001111000011110000111100001111000011110000111100000000111100001111000011110000111100001111000011110000111100001111",
--R
"11111111111100001111111111110000111111111111000011111111111100001111000000001111111100000000111111110000000011111111000000001111111111111111000011111111111100001111111111110000111111111111000011110000111100001111000011110000111100001111000011110000111100001111000000001111111100000000111111110000000011111111000000001111",
--S
"00001111111111110000111111111111000011111111111100001111111111111111000000000000111100000000000011110000000000001111000000000000000011111111000000001111111100000000111111110000000011111111000000000000000011110000000000001111000000000000111100000000000011111111111111110000111111111111000011111111111100001111111111110000",
--T
"11111111111111111111111111111111111111111111111111111111111111110000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111000000",
--U
"11110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011110000111111110000000011111111000000001111111100000000111111110000",
--V
"11100000000001111110000000000111111000000000011111100000000001111110000000000111111000000000011111100000000001111110000000000111000111000011100000011100001110000001110000111000000111000011100000011100001110000001110000111000000111000011100000011100001110000000001111000000000000111100000000000011110000000000001111000000",
--W
"11100000000001111110000000000111111000000000011111100000000001111110000000000111111000000000011111100000000001111110000000000111111000111100011111100011110001111110001111000111111000111100011111111100001111111111110000111111111111000011111111111100001111111110000000000111111000000000011111100000000001111110000000000111",
--X
"11110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111000000001111000011111111000000001111111100000000111111110000000011111111000011110000000011111111000000001111111100000000111111110000000011111111000000001111111100000000111111110000000011111111000000001111",
--Y
"11100000000001111110000000000111111000000000011111100000000001111110000000000111111000000000011111100000000001111110000000000111000111111111100000011111111110000001111111111000000111111111100000000011110000000000001111000000000000111100000000000011110000000000001111000000000000111100000000000011110000000000001111000000",
--Z
"11111111111111111111111111111111111111111111111111111111111111110000000011110000000000001111000000000000111100000000000011110000000011110000000000001111000000000000111100000000000011110000000011110000000000001111000000000000111100000000000011110000000000001111111111111111111111111111111111111111111111111111111111111111"
);

signal line_counter: integer range 0 to 15 := 0;
signal led_counter: integer range 0 to 63 := 0;
signal debug_led: integer range 0 to 8 := 0;

signal current_char: std_logic_vector(0 to 319) := letters(0);


constant ENABLE: std_logic := '0';
constant DISABLE: std_logic := not ENABLE;


begin

clk_pin_i <= display_clock;
clk_debug_i <= display_clock;
lines_i <= std_logic_vector(to_unsigned(line_counter, lines_i'length));
lines_debug_i <= std_logic_vector(to_unsigned(line_counter, lines_i'length));

framebuffer(64 *  6 + 5 to 64 *  6 + 20) <= current_char(  0 to  15); -- 5 - 20
framebuffer(64 *  7 + 5 to 64 *  7 + 20) <= current_char( 16 to  31);
framebuffer(64 *  8 + 5 to 64 *  8 + 20) <= current_char( 32 to  47);
framebuffer(64 *  9 + 5 to 64 *  9 + 20) <= current_char( 48 to  63);
framebuffer(64 * 10 + 5 to 64 * 10 + 20) <= current_char( 64 to  79);
framebuffer(64 * 11 + 5 to 64 * 11 + 20) <= current_char( 80 to  95);
framebuffer(64 * 12 + 5 to 64 * 12 + 20) <= current_char( 96 to 111);
framebuffer(64 * 13 + 5 to 64 * 13 + 20) <= current_char(112 to 127);
framebuffer(64 * 14 + 5 to 64 * 14 + 20) <= current_char(128 to 143);
framebuffer(64 * 15 + 5 to 64 * 15 + 20) <= current_char(144 to 159);
framebuffer(64 * 16 + 5 to 64 * 16 + 20) <= current_char(160 to 175);
framebuffer(64 * 17 + 5 to 64 * 17 + 20) <= current_char(176 to 191);
framebuffer(64 * 18 + 5 to 64 * 18 + 20) <= current_char(192 to 207);
framebuffer(64 * 19 + 5 to 64 * 19 + 20) <= current_char(208 to 223);
framebuffer(64 * 20 + 5 to 64 * 20 + 20) <= current_char(224 to 239);
framebuffer(64 * 21 + 5 to 64 * 21 + 20) <= current_char(240 to 255);
framebuffer(64 * 22 + 5 to 64 * 22 + 20) <= current_char(256 to 271);
framebuffer(64 * 23 + 5 to 64 * 23 + 20) <= current_char(272 to 287);
framebuffer(64 * 24 + 5 to 64 * 24 + 20) <= current_char(288 to 303);
framebuffer(64 * 25 + 5 to 64 * 25 + 20) <= current_char(304 to 319);


r0_debug_i <= '1' when (line_counter = 1 and led_counter > 0 and led_counter < 64) else '0';


     
r_i <= framebuffer(line_counter * 64 + led_counter) & 
       framebuffer((line_counter + 16) * 64 + led_counter); 
       
g_i <= framebuffer(line_counter * 64 + led_counter) & 
       framebuffer((line_counter + 16) * 64 + led_counter); 
       
b_i <= framebuffer(line_counter * 64 + led_counter) & 
       framebuffer((line_counter + 16) * 64 + led_counter); 
       
--Generate the display_clock and internal_display_clock signals
--They are basically the same, but display_clock is routed
--directly to the clock pin of the display, and it is only active,
--when display data is being sent to the panel.
--internal_display_clock is used internally to sync, to set the different
--signals, according to the statemachine. Using that changing the display
--data will be in sync with the actual display.
display_clk_gen: process(clk_i)
variable clk_cnt: integer range 0 to display_div;
begin
    if rising_edge(clk_i) then
        clk_cnt := clk_cnt + 1;
        if clk_cnt = display_div then
            clk_cnt := 0;
            internal_display_clock <= not internal_display_clock;
            if current_state = SERIAL_OUT then
				display_clock <= not display_clock;
			end if;
        end if;
    end if;
end process display_clk_gen;


--This process is only for demo/debugging. It changes the displayed
--letter every 8M clock cycles.
char_switcher: process(internal_display_clock)
variable cnt1: integer := 0;
variable charcnt: integer range 0 to 25 := 0;
begin
	if rising_edge(internal_display_clock) then
		if cnt1 = 8000000 then -- arbitrary clock cycle number, for a demo this is big enough
			current_char <= letters(charcnt);
			if charcnt = 25 then
				charcnt := 0;
			else
				charcnt := charcnt + 1;
			end if;
			
			cnt1 := 0;
		else
			cnt1 := cnt1 + 1;
		end if;
	end if;
end process char_switcher;


--The main statemachine, the heart. This is described in the README.
--But also, it's not that long.
state_machine: process(internal_display_clock)
variable wait_counter: integer range 0 to 1000 := 0;
variable line_cnt_var: integer range 0 to 15 := 0;
variable led_cnt_var: integer range 0 to 63 := 0;
begin
    if falling_edge(internal_display_clock) then
        case current_state is
            when ENABLE_ON =>
                --debug_led <= 1;
                oe_i <= ENABLE;
                oe_debug_i <= ENABLE;
                lat_i <= ENABLE;
                lat_debug_i <= ENABLE;
                if wait_counter = 3 then
                    lat_i <= DISABLE;
                    lat_debug_i <= DISABLE;
                end if;
                    
                if wait_counter = 500 then -- while oe is enabled, the LED stays on - the longer it is on, the brighter it is.
										   -- of course it needs some balance, so that it doesn't kill the refresh rate
										   -- let's see if 500 clock cycles is good enough for both.
					current_state <= SWITCH_LINE;
					wait_counter := 0;
				else
					wait_counter := wait_counter + 1;	
				end if;
                
            when SWITCH_LINE =>
				--debug_led <= 2;
				
				oe_i <= DISABLE;
                oe_debug_i <= DISABLE;
                lat_i <= DISABLE;
                lat_debug_i <= DISABLE;
				
				if wait_counter = 0 then
					if line_cnt_var = 15 then
						line_cnt_var := 0;
					else
						line_cnt_var := line_cnt_var + 1;
					end if;
				end if;
				
                if wait_counter = 10 then
					current_state <= SERIAL_OUT;
					wait_counter := 0;
				else
					wait_counter := wait_counter + 1;
				end if;
			when SERIAL_OUT =>
				oe_i <= DISABLE;
                oe_debug_i <= DISABLE;
                lat_i <= DISABLE;
                lat_debug_i <= DISABLE;
				if led_cnt_var = 63 then
					led_cnt_var := 0;
					current_state <= ENABLE_ON;
				else
					led_cnt_var := led_cnt_var + 1;
				end if;
			when others =>
                oe_i <= DISABLE;
                oe_debug_i <= DISABLE;
                lat_i <= DISABLE;
                lat_debug_i <= DISABLE;
        end case;
    end if;
    line_counter <= line_cnt_var;
    led_counter <= led_cnt_var;
end process state_machine;


end Behavioral;
